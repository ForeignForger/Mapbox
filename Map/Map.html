<html>
<head>

<link href='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
<link href='css/style.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
<script src='js/library/jquery.min.js'></script>
<script src='js/library/knockout.js'></script>
</head>
<body>
<p>Hello there!</p>
<div id='mapbox' class="map">
</div>
<script src='js/Layers.js'></script>
<script src='js/ControlPanels.js'></script>
<script src='js/Controls.js'></script>
<script src='js/Mapbox.js'></script>
<script type="application/json" id="mapbox-layers-json">
{
	"info": {
		"controlPanels":[
			{
				"position": "top-right",
				"panelHtml": "<div class='control-panel top-right'><div class='toggle control-panel-toggle' data-bind='click: toggleControlPanel, css: { open: IsOpen() }'></div><div class='control-area'><div class= 'head'><div><div class='control-name' data-bind='click: toggleControlList'><span data-bind='text:selectedControl().controlName'></span></div><ul class='control-list' data-bind='foreach: controls, css: {open: IsControlListOpen}'><!-- ko if: $parents[0].selectedControl().controlId != controlId--><li class='control-list-element' data-bind='text: controlName, click: $parents[0].selectControl.bind($element[0], controlId)'></option><!-- /ko --></ul></div></div><div class='body' data-bind='with: selectedControl'></div></div></div>",
				"controls":	[
						{
							"layerId": "mcd",
							"controlId": "main-control",
							"controlHtml": "<div class='main-control'><div class='control-head'><div class='toggle layer-toggle' data-bind='css: { shown: layers[mainLayer.layerId].IsLayerShown()}, click: showHideLayer.bind(null, $data, mainLayer.layerId)'></div><span class='layer-name' data-bind='text: mainLayer.layerName, click: showHideLayerMenu.bind(null, $data, mainLayer.layerId), css: {active: layers[mainLayer.layerId].isLayerActive()}'></span></div><div class='control-body' data-bind='visible: layers[mainLayer.layerId].IsLayerShown() && layers[mainLayer.layerId].IsLayerMenuShown()'><ul class='element-list' data-bind='foreach: mainLayer.elements'><li class='element'><div class='toggle element-toggle' data-bind='css: { shown:  $parent.layers[$parent.mainLayer.layerId].elements[elementId].IsElementShown() }, click: $parent.toggleElementFilter.bind(null, $parent, elementId, $parent.mainLayer.layerId)'></div><span class='element-name' data-bind='text: elementName'></span></li></ul><div class='layer-list' data-bind='foreach: mainLayer.childLayerObjects'><div class='layer'><div class='layer-head'><div class='toggle layer-toggle' data-bind='css: { shown: $parent.layers[layerId].IsLayerShown() }, click: $parent.showHideLayer.bind(null, $parent, layerId)'></div><span class='layer-name' data-bind='text: layerName, click: $parent.showHideLayerMenu.bind(null, $parent, layerId), css: {active:  $parent.layers[layerId].isLayerActive()}'></span></div><div class='layer-body' data-bind='visible: $parent.layers[layerId].IsLayerShown() && $parent.layers[layerId].IsLayerMenuShown()'><ul class='child-layer-list' data-bind='foreach: childLayerObjects'><li class='child-layer'><div class='toggle layer-toggle'></div><span class='layer-name' data-bind='text: layerName'></span></li></ul></div></div></div></div></div>",
							"controlName": "Главный котроллер"
						},
						{
							"layerId": "",
							"controlId": "time-line-control",
							"controlHtml": "<div>Time line control<div>",
							"controlName": "Фильтрация по времени"
						}
					]
			}
		]
	},
	"layers":[
		{
			"id": "mcd",
			"type": "symbol",
			"source": {
				"type": "geojson",
				"data": {
					"type": "FeatureCollection",
					"features": []
				}
			},
			"metadata":
			{
				"elements": [
					{
						"elementId": "mcd1",
						"elementName": "Старый МЦД"
					}, 
					{
						"elementId": "mcd2",
						"elementName": "Новый МЦД"
					}
				],
				"parentLayers": [],
				"childLayers": ["mcd-roads", "mcd-stations"],
				"popupHtml": "",
				"layerName": "Схема Московских МЦД"
			}
		},
		{
			"id": "mcd-roads",
			"type": "line",
			"metadata":{
				"elements": [],
				"parentLayers": ["mcds"],
				"childLayers": ["mcd-road-speedInfos"],
				"popupHtml": "<div><span>This is <span data-bind='text: name'></span></span></div>",
				"layerName": "Дороги"
			},
			"minzoom": 10,
			"source":{
				"type": "geojson",
				"data":{
					"type": "FeatureCollection",
					"features": [
						{
							"geometry": {
								"coordinates": [
								  [
									37.51083821856241,
									55.80581875221003
								  ],
								  [
									37.506376619076406,
									55.801074060530595
								  ],
								  [
									37.49104590147289,
									55.792089881848625
								  ],
								  [
									37.483677975690114,
									55.78737603255277
								  ],
								  [
									37.477114854580805,
									55.77485670638677
								  ],
								  [
									37.50451730716179,
									55.77051680425677
								  ],
								  [
									37.537415789839116,
									55.76608168789562
								  ],
								  [
									37.545880138120026,
									55.77328954924437
								  ],
								  [
									37.55255808063089,
									55.77430655915603
								  ],
								  [
									37.554372962104225,
									55.775324211013015
								  ],
								  [
									37.55753591330665,
									55.779669789760675
								  ],
								  [
									37.565692073248755,
									55.78537418334437
								  ],
								  [
									37.53152720334515,
									55.80053910318847
								  ],
								  [
									37.51085091641019,
									55.80582699437832
								  ]
								],
								"type": "LineString"
							},
							"type": "Feature",
							"properties": {
								"year": "2010",
								"ownerLayer": "mcds",
								"ownerElement": "mcd1",
								"popupData": {"name": "mcd1road"}
							}
						},
						{
							"geometry": {
								"coordinates":[
								  [
									37.495392263269736,
									55.670587715832426
								  ],
								  [
									37.53637737683738,
									55.69347366722812
								  ],
								  [
									37.56179907019967,
									55.712306591392064
								  ],
								  [
									37.584540709855304,
									55.728663354556545
								  ],
								  [
									37.59213448671187,
									55.73181451836598
								  ],
								  [
									37.594411441126766,
									55.73558548562181
								  ],
								  [
									37.589744857504854,
									55.737104301161935
								  ],
								  [
									37.586226731456435,
									55.73879694066204
								  ],
								  [
									37.583679630162806,
									55.74426840330318
								  ],
								  [
									37.58261611338614,
									55.746866356842105
								  ],
								  [
									37.58372680092583,
									55.75443916701795
								  ],
								  [
									37.58435286970294,
									55.75783360451632
								  ],
								  [
									37.584766916942755,
									55.75913019232189
								  ],
								  [
									37.589128372173235,
									55.76536317247954
								  ],
								  [
									37.591063366886175,
									55.76716049535028
								  ],
								  [
									37.59281860900461,
									55.76804515152182
								  ],
								  [
									37.59677400024171,
									55.76976632899701
								  ],
								  [
									37.5986952660806,
									55.77057995770886
								  ],
								  [
									37.60358349482766,
									55.77219459139516
								  ],
								  [
									37.604822545157305,
									55.77309502177954
								  ],
								  [
									37.60894712253432,
									55.77789737911576
								  ],
								  [
									37.616752074525266,
									55.78356022500438
								  ],
								  [
									37.62523946043396,
									55.7927871359187
								  ],
								  [
									37.63248333473709,
									55.79182019754941
								  ],
								  [
									37.63960907478676,
									55.7922116256278
								  ],
								  [
									37.64770163567897,
									55.78238845392485
								  ],
								  [
									37.652688887450665,
									55.776742309037445
								  ],
								  [
									37.6557569555107,
									55.77079780445797
								  ],
								  [
									37.673047843309575,
									55.77188036588399
								  ],
								  [
									37.688723052665296,
									55.77034247369906
								  ],
								  [
									37.72702310099655,
									55.77039769181778
								  ],
								  [
									37.73086342386648,
									55.78636273429163
								  ]
								],
								"type": "LineString"
							},
							"type": "Feature",
							"properties": {
								"year": "2009",
								"ownerLayer": "mcds",
								"ownerElement": "mcd2",
								"popupData": {"name": "mcd2road"}
							}
						}	
					]
				}
			},
			"layout": {
				"line-join": "round",
				"line-cap": "round"
			},
			"paint": {
				"line-color": "#888",
				"line-width": 4
			}
		},
		{
			"id": "mcd-stations",
			"type": "symbol",
			"metadata":{
				"elements": [],
				"parentLayers": ["mcds"],
				"childLayers": [],
				"popupHtml": "<div><span>This is <span data-bind='text: name'></span></span></div>",
				"layerName": "Станции"
			},
			"minzoom": 10,
			"source": {
				"type": "geojson",
				"data": {
					"type": "FeatureCollection",
					"features": [
						{
							"geometry": {
								"coordinates": [
								  37.51075877503524,
								  55.80602449730338
								],
								"type": "Point"
							},
							"type": "Feature",
							"properties": {
								"year": "2010",
								"ownerLayer": "mcds",
								"ownerElement": "mcd1",
								"popupData": {"name": "mcd1Station Station1"}
							}
						},{
							"geometry": {
								"coordinates": [
									37.47707180009223,
									55.7749305650959
								],
								"type": "Point"
							},
							"type": "Feature",
							"properties": {
								"year": "2010",
								"ownerLayer": "mcds",
								"ownerElement": "mcd1",
								"popupData": {"name": "mcd1Station Station2"}
							}
						},{
							"geometry": {
								"coordinates": [
								  37.53765953509131,
								  55.7659945672583
								],
								"type": "Point"
							},
							"type": "Feature",
							"properties": {
								"year": "2010",
								"ownerLayer": "mcds",
								"ownerElement": "mcd1",
								"popupData": {"name": "mcd1Station Station3"}
							}
						},{
							"geometry": {
								"coordinates": [
								  37.56581810974279,
								  55.785564268604986
								],
								"type": "Point"
							},
							"type": "Feature",
							"properties": {
								"year": "2010",
								"ownerLayer": "mcds",
								"ownerElement": "mcd1",
								"popupData": {"name": "mcd1Station Station4"}
							}
						}
					]
				}
			},
			"layout": {
				"icon-image": "marker-red",
				"text-field": "Station",
				"text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
				"text-offset": [0, 0.6],
				"text-anchor": "top"
			}
		}
	]
}
</script>
<script>
	var settings = {containerId: "mapbox", layersJsonContainerId: "mapbox-layers-json"};
	var mapbox = new Mapbox();
	mapbox.run(settings);
</script>

</body>
</html>